/*! PageNavigator - v1.0 - 2013-06-09 4:41:00 PM
* Copyright (c) 2013 PageNavigator; Licensed  */
KISSY.add("gallery/PageNavigator/1.0/index",function(a){function b(a){var c=this;b.superclass.constructor.call(c,a),this.initializer()}var c=Node.all,d=window,e=a.DOM,f=6===a.UA.ie;return a.extend(b,a.Base,{scrollNode:a.all("html , body"),initializer:function(){return this.node=this.get("node"),this.node?(this._parseHtmlToNavigators(this.node,this.get("navItemSelector")),this.setNavigatorsTop(this.get("navigators")),this.renderUI(),this.bindUI(),void 0):(a.log("\u521d\u59cb\u5316\u5931\u8d25\uff1a\u6ca1\u6709\u6307\u5b9a\u5bfc\u822a\u6761\u6240\u5728\u8282\u70b9"),void 0)},renderUI:function(){},bindUI:function(){this.node.delegate("click",this.get("navItemSelector"),this._clickNavigatorHandler,this),a.one(d).on("scroll",a.buffer(this._scrollHandler,this.get("interval"),this)),this.on("afterActiveNavigatorChange",function(a){a.prevVal&&a.prevVal.srcNode.removeClass("selected"),a.newVal.srcNode&&a.newVal.srcNode.addClass("selected")},this),this.on("afterVisibleChange",function(a){a.newVal?this.node.show():this.node.hide()},this)},_clickNavigatorHandler:function(b){var c=this;b.preventDefault();var d=a.one(b.currentTarget);this.clickedNavigator=d.data("navigator"),setTimeout(function(){c.clickedNavigator=null},this.get("duration")+200),this.scrollTo(d.data("navigator"))},_scrollHandler:function(){var a=this.get("threshold");a>0?this.set("visible",e.scrollTop()>a):this.set("visible",!0),this.get("enableAutoSelect")&&this._checkRegion(),f&&(this.node[0].className=this.node[0].className)},_checkRegion:function(){for(var b=this.get("navigators"),c=this.viewportRegion(),d=[],e=null,f=0,g=b.length;g>f;f++){var h=b[f].scrollTo.to;h instanceof a.NodeList&&(h.data("region",this.region(h)),this.inRegion(h.data("region"),c)&&(b[f].intersectRegion=this.intersect(h.data("region"),c),d.push(b[f])))}if(d.length>0){if(d.sort(function(a,b){return b.intersectRegion.height-a.intersectRegion.height}),e=d[0],null!==this.clickedNavigator)for(f=0,g=d.length;g>f;f++)d[f]===this.clickedNavigator&&(e=this.clickedNavigator);this.set("activeNavigator",e)}},region:function(a){var b=a.offset(),c=a.outerWidth(),d=a.outerHeight();return{left:b.left,top:b.top,right:b.left+c,bottom:b.top+d,width:c,height:d}},viewportRegion:function(){var a=e.scrollLeft(),b=e.scrollTop(),c=e.viewportWidth(),d=e.viewportHeight();return{left:a,top:b,right:a+c,bottom:b+d,width:c,height:d}},inRegion:function(a,b,c){c=c||!1;var d=!0,e=!0;c&&(d=a.right<=b.right&&a.left>=b.left,e=a.bottom<=b.bottom&&a.top>=b.top);var f=(a.top>=b.top&&a.top<=b.bottom||a.top<=b.top&&a.bottom>=b.top)&&d,g=(a.left>=b.left&&b.left<=b.right||a.left<=b.left&&a.right>=b.left)&&e;return f&&g},intersect:function(a,b){var c=Math.max(a.left,b.left),d=Math.min(a.right,b.right),e=Math.max(a.top,b.top),f=Math.min(a.bottom,b.bottom);return{left:c,top:e,right:d,bottom:f,width:d-c,height:f-e}},setNavigatorsTop:function(b){a.each(b,function(a){a.top=this._getTop(a.scrollTo.to)+a.scrollTo.threshold},this)},scrollTo:function(a){var b=this;c(d).stop(),this.fire("scrolling",{scrolling:!0,data:a});var e=this._getTop(a.scrollTo.to)+a.scrollTo.threshold;a.top=e,c(d).animate({scrollTop:e},this.get("duration")/1e3,this.get("easing"),function(){b.fire("scrolling",{scrolling:!1,data:a})})},_parseHtmlToNavigators:function(b,c){var d=[];b.all(c).each(function(b){var c=b.attr("data-navigator"),e={},f=a.one(b.attr("href"));c=a.JSON.parse(c)||{},a.log(c),c=a.mix({threshold:0,to:0},c,void 0,void 0,!0),f&&(c.to=f),e={srcNode:b,scrollTo:c},d.push(e),b.data("navigator",e)}),this.set("navigators",this.get("navigators").concat(d))},_getTop:function(b){switch(!0){case a.isNumber(b):return b;case a.isString(b):var c=a.one(b);if(c)return c.offset().top;a.log("\u6ca1\u6709\u627e\u5230\u5bf9\u5e94\u8282\u70b9");break;case b instanceof a.NodeList:return b.offset().top}},_setThreshold:function(b){return a.isString(b)&&a.one(b)?a.one("val"):a.isNumber(b)?b:0}},{ATTRS:{node:{value:null,setter:function(b){return a.isString(b)?a.one(b):b}},navItemSelector:{value:".J_PageNavigator"},enableAutoSelect:{value:!0},navSelectedClass:{value:"selected"},navigators:{value:[]},activeNavigator:{value:null},threshold:{value:0,setter:"_setThreshold"},visible:{value:!0},interval:{value:400},duration:{value:800},easing:{value:"easeOut"}}}),b},{requires:["node","dom","base","anim","ua"]});